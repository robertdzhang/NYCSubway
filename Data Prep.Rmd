---
title: "Data Prep"
output: html_document
---

# Data Prep for Shiny WebApp

```{r message=FALSE, warning=FALSE, results ='hide'}
library(data.table)
library(dtplyr)
library(tidyverse)
library(tidycensus)
library(sf)
library(lubridate)
library(gganimate)
```

## Setting up Data & Generating Useful Metrics
- https://medium.com/qri-io/taming-the-mtas-unruly-turnstile-data-c945f5f96ba0 was an important resource for this section.
- http://web.mta.info/developers/developer-data-terms.html#data provided much of the data.

```{r eval=FALSE}
turnstile_data <- readRDS("data/turnstile-data.RDS")
```

Numbers are not exact, as invalid net entries and exits are discarded, rather than
converted into valid numbers (since we can't tell what the valid numbers are).

### The following code is for the dplyr package. Equivalent code in the faster data.tables package is below (which is the actual code that's run)
```{r eval=FALSE}
dplyr_start <- proc.time()

get_date_turnstile_data_df <- function(theDate, template) {
  return(read_delim(paste0(
    template, format(theDate, "%y%m%d"), ".txt"
  ), ","))
}
start <- as.Date("02-01-20", format = "%m-%d-%y")
end   <- as.Date("06-06-20", format = "%m-%d-%y")
date_vector <- seq(from = start, to = end, by = 7)
turnstile_data_list_df <-
  map(date_vector, get_date_turnstile_data_df, "data/turnstile_")
turnstile_data_df <- bind_rows(turnstile_data_list_df)

turnstile_data_df <- turnstile_data_df %>%
  mutate(DATE = mdy(DATE),
         ENTRIES = as.numeric(ENTRIES)) %>% rename(EXITS = `EXITS                                                               `) %>% mutate(EXITS = as.numeric(EXITS)) %>%
  mutate(DATETIME = ymd_hms(paste(DATE, TIME)))
turnstile_data_df <- turnstile_data_df %>%
  mutate(id = paste(`C/A`, UNIT, SCP, DATE, TIME)) %>%
  mutate(unit_id = paste(`C/A`, UNIT, SCP)) %>%
  arrange(id)

saveRDS(turnstile_data_df, "data/turnstile-data-df.RDS")
```

#### PROCESSING BEGIN (dplyr)
```{r eval=FALSE}
turnstile_data_df <- readRDS("data/turnstile-data-df.RDS")
turnstile_data_df <- turnstile_data_df %>%
  group_by(unit_id) %>%
  mutate(net_entries = abs(ENTRIES - lag(ENTRIES, 1)),
         net_exits = abs(EXITS - lag(EXITS, 1))) %>%
  mutate(net_entries = replace(net_entries, net_entries > 10000, 0)) %>% 
  mutate(net_exits = replace(net_exits, net_exits > 10000, 0)) %>% 
  ungroup()

station_booths_df <- readxl::read_excel("data/Remote-Booth-Station.xls")
remote_complex_lookup_df <- read_csv("data/remote_complex_lookup.csv")
turnstile_data_joined_df <- turnstile_data_df %>% left_join(remote_complex_lookup_df,
                                                       by = c("UNIT" = "remote",
                                                              "C/A" = "booth"))
stations_df <- read_csv("data/Stations.csv")
turnstile_data_joined_stations_df <-
  turnstile_data_joined_df %>%
  left_join(
    stations_df %>%
      group_by(`Complex ID`) %>%
      filter(row_number() == 1) %>%
      ungroup(),
    by = c("complex_id" = "Complex ID")
  ) %>%
  filter(DIVISION != "PTH", DIVISION != "RIT")

turnstile_summaries_df <-
  turnstile_data_joined_stations_df %>%
  group_by(round_date(DATETIME, "4 hours")) %>%
  filter(n() > 5) %>%
  summarize(entry_sum = sum(net_entries, na.rm = TRUE),
                                exit_sum = sum(net_exits, na.rm = TRUE)) %>% 
  rename(datetime = 1)

# proc.time() - dplyr_start
```

### Actual code with the Data.Table package (more opaque syntax but significantly faster)
```{r DATA.TABLE, eval = FALSE}
data.table_start <- proc.time()
get_date_turnstile_data_dt <- function(theDate, template) {
  return(fread(paste0(
    template, format(theDate, "%y%m%d"), ".txt"
  ), sep = ","))
}
start <- as.Date("02-01-20", format = "%m-%d-%y")
end   <- as.Date("06-06-20", format = "%m-%d-%y")
date_vector <- seq(from = start, to = end, by = 7)
turnstile_data_list_dt <-
  lapply(date_vector, get_date_turnstile_data_dt, "data/turnstile_")
turnstile_data_dt <- rbindlist(turnstile_data_list_dt)
turnstile_data_dt[, c("DATE", "DATETIME", "id", "unit_id") := .(
  mdy(DATE),
  mdy_hms(paste(DATE, TIME)),
  paste(`C/A`, UNIT, SCP, DATE, TIME),
  paste(`C/A`, UNIT, SCP))]

saveRDS(turnstile_data_dt, "data/turnstile-data-dt.RDS")
# turnstile_data_dt <- readRDS("data/turnstile-data-dt.RDS")
```

#### PROCESSING BEGIN (data.table)
```{r DATA.TABLE, eval = TRUE}
turnstile_data_dt <- readRDS("data/turnstile-data-dt.RDS")
turnstile_data_dt[,
                  c('net_entries', 'net_exits') :=
                    .(abs(ENTRIES - shift(ENTRIES, 1, type = "lag")),
                      abs(EXITS - shift(EXITS, 1, type = "lag"))),
                  by = .(unit_id)][net_entries > 10000, net_entries := 0][net_exits > 10000, net_exits := 0]

station_booths_dt <-
  data.table(readxl::read_excel("data/Remote-Booth-Station.xls"))
remote_complex_lookup_dt <- fread("data/remote_complex_lookup.csv")
turnstile_data_joined_dt <-
  remote_complex_lookup_dt[turnstile_data_dt, on = c("remote" = "UNIT",
                                                   "booth" = "C/A")]

stations_dt <- fread("data/Stations.csv")
turnstile_data_joined_stations_dt <-
  stations_dt[, head(.SD, 1), by = "Complex ID"][turnstile_data_joined_dt, on = c("Complex ID" = "complex_id")][DIVISION != "PTH" & DIVISION != "RIT",]

turnstile_summaries_dt <-
  turnstile_data_joined_stations_dt[,.(
    .N,
    entry_sum = sum(net_entries, na.rm = TRUE),
    exit_sum = sum(net_exits, na.rm = TRUE)
  ), by = .(datetime = round_date(DATETIME, "4 hours"))][N > 5, !"N"][order(datetime)]

# proc.time() - data.table_start
```

**Verify that data.table and dplyr give the same results**
```{r}
all(turnstile_summaries_df$entry_sum == turnstile_summaries_dt$entry_sum)
all(turnstile_summaries_df$exit_sum == turnstile_summaries_dt$exit_sum)
all(turnstile_summaries_df$datetime == turnstile_summaries_dt$datetime)
```

```{r}
ggplot(
  data = as_tibble(turnstile_summaries_dt) %>% group_by(the_date = date(datetime)) %>% summarize(
    entry_sum = sum(entry_sum),
    exit_sum = sum(exit_sum)
  ) %>% pivot_longer(ends_with("_sum"), names_to = 'sumtype', values_to = 'the_sum')
) +
  geom_line(mapping = aes(
    x = the_date,
    y = the_sum,
    group = sumtype,
    color = sumtype
  )) +
  geom_point(mapping = aes(
    x = the_date,
    y = the_sum,
    group = sumtype,
    color = sumtype
  )) +
  labs(
    title = "Total Daily Turnstile Entries and Exits",
    x = "Date",
    y = "Total Daily Count",
    color = "Legend",
    subtitle = paste(
      "Orange Vertical Line is when State of Emergency was Declared in NYC (March 12)",
      "Red Vertical Line is when Statewide Stay-At-Home Order was Enacted (March 22)",
      sep = "\n"
    )
  ) +
  scale_color_manual(values = c("#7cae00", "#00bfc4"), labels = c("Entries", "Exits")) +
  theme(legend.position = "right") +
  scale_y_continuous(labels = scales::comma) +
  geom_vline(
    mapping = aes(xintercept = mdy("03-12-2020")),
    color = "dark orange",
    linetype = "dashed"
  ) +
  geom_vline(
    mapping = aes(xintercept = mdy("03-22-2020")),
    color = "red",
    linetype = "dashed"
  )
```

```{r}
turnstile_summaries_dt_shiny <- copy(turnstile_summaries_dt)
turnstile_summaries_dt_shiny[, DayOfWeek := wday(datetime, label=TRUE)][, IsWeekday := DayOfWeek %in% c("Sat", "Sun")][, "DayOfWeek" := NULL]
saveRDS(as_tibble(turnstile_summaries_dt_shiny), "app/turnstile-summaries-shiny.RDS")
```

